Manage Storage Stack

Logical Volume Manager

Use the Logical Volume Manager (LVM) system to create logical storage volumes as a layer on the physical storage. 
This storage system provides greater flexibility than using physical storage directly. LVM hides the hardware storage
configuration from the software and enables you to resize volumes without stopping applications or unmounting file systems. 
LVM provides comprehensive command-line tools to manage storage.

Benefits:

- Flexible Storage Management.
- You can manage the storage(Add disk) using LVM and avoid downtime. 
- Better disk utilization.

Main Components:
- Raw Disk(Storage)
	|
	|
- Physical Volume
	|
	|
- Volume Group
	|
	|
- Logical Volume	-------> Assign the File System	-----------> Add Mountpoint (Ready to be used)

----------------------------------------------

- fdisk /dev/sdb
- Create 4 partitions
	/dev/sdb1	- 500MB
	/dev/sdb2	- 500MB
	/dev/sdb3	- 500MB
	/dev/sdb5	- 400MB Extended Partition

- pvcreate /dev/vdb1 /dev/vdb2 /dev/svb3 /dev/vdb5	\Create Physical volume
- vgcreate datastore /dev/vdb1 /dev/vdb2 /dev/vdb3 /dev/vdb5	\create a pool of volume with name datastore
- vgdisplay datastore 	\to display the created volume pool :Check the PE size
- lvcreate -L 600M -n database datastore 	\Create the lvm name database with 600MB. 
- pvs 		\##To list from where the volume/size is picked by lvm. 
- mkfs.ext4 /dev/mapper/datasotre-database 	\To make the filesystem in the logical volume. Mapper is the technology.
- mkdir	/lvdata
- mount /dev/mapper/datastore-database	/lvdata/	\Mount the recent created directory to the mount pouint of lvm

#Add addtion storage to the existing lvm

- Add a new disk.(Storage disk)
- fdisk /dev/vdc
	- Create the partition of decent size. 
- pvcreate /dev/vdc1
- vgextend datastore /dev/vdc1
- vgdisplay datastore 	\to view the new extended storage is added or not. 
- lvresize -L +1000M	/dev/datastore/database		\Increase the size of the datastore
- df -h 	\To view if the changes are reflected or not. 

#If the changes are not reflected, you would need to assign the filesystem to the extended storage.
- df -hT 	\to find the type of filesystem of the mapper
- resize2fs /dev/mapper/datastore-database  \It will update the datastore to the exisiting filesystem
- df -hT	\ To check again if the changes are reflected.

#How to avoid resize2fs when creating the resize again.  
- lvresize -L +300M -r /dev/datastore/database		\Use the r option to update the filesystem automatically. 


-------------------------------------------------
Note: To make the 
lvm permanent, make the entry to fstab file. 

After any change, we need to run the resize2fs -- to update the filesystem to reflect the added disk.
-----------------------------------------------
To remove the created lvms follow these

- Remove the entries from fstab
- umount /dev/mapper/datastore-database
- swapoff /dev/dm-3
- Run lsblk			\To check you turned off the right swap
- Run wipefs -a /dev/mapper/datastore-database
- Run wipefs -a /dev/mapper/datastore-swap
- lvremove /dev/datastore/database
		- Confirm if you want to remove.
- lvremove /dev/datastore/swap
		- Confirm the removal
- vgremove datastore
- pvremove	/dev/vdb1	/dev/vdb2	/dev/vdb3	/dev/vdb5	/dev/vdc1	/dev/vdc2
- fdisk in /dev/vdb
	- d \to delete the partition
- fdisk in /dev/vdc
	- d \to delete the partition
- partprobe /dev/vdb /dev/vdc			\To ask the kernel to check the changes made in these directories.


